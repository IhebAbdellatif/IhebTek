<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IhebTek - Dashboard</title>
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url('/assets/gallery/gallery1.png') center/cover fixed no-repeat;
      color: #222;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-top: 40px;
      padding-bottom: 40px;
    }

    /* Logo at top */
    #topLogo {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 350px;
      height: auto;
      z-index: 100;
    }

    .page { display: none; width: 100%; max-width: 500px; }
    .active { display: block; }

    /* Glass Panel */
    .glass-panel {
      padding: 32px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
      text-align: center;
    }

    /* Form */
    .form-container h2, .receipt-container h2 {
      color: #0d47a1;
      margin-top: 0;
      font-weight: 700;
    }
    .form-container h3 {
      color: #1565c0;
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin: 16px 0 8px;
      font-weight: 600;
      color: #01579b;
      text-align: left;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.85);
      font-size: 15px;
    }
    textarea { height: 80px; resize: vertical; }
    button.submit-btn {
      background: linear-gradient(120deg, #00796b, #009688);
      color: white;
      border: none;
      padding: 14px;
      width: 100%;
      font-size: 17px;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: 600;
    }
    .half { display: flex; gap: 16px; }
    @media (max-width: 600px) { .half { flex-direction: column; } }

    /* Receipt */
    .print-btn {
      background: linear-gradient(120deg, #0288d1, #29b6f6);
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 15px;
    }
    .close-btn {
      background: linear-gradient(120deg, #c62828, #e57373);
      margin-top: 10px;
    }

    /* Print */
    @media print {
      body {
        background: white !important;
        padding: 0;
        margin: 0;
      }
      .glass-panel {
        background: white !important;
        border: none;
        box-shadow: none;
        padding: 20px;
      }
      .receipt-container { display: block !important; }
      #topLogo { display: none; }
    }
  </style>
</head>
<body>

  <img src="/assets/logo.png" alt="IhebTek Logo" id="topLogo">

  <!-- FORM (now the only page) -->
  <div id="formPage" class="page active">
    <div class="glass-panel form-container">
      <h2>IhebTek</h2>
      <h3>Soumission d'appareil</h3>
      <form id="deviceForm">
        <label>Nom du client *</label>
        <input type="text" id="clientName" required />

        <div class="half">
          <div><label>T√©l√©phone *</label><input type="tel" id="phone" required /></div>
          <div><label>Email (optionnel)</label><input type="email" id="email" /></div>
        </div>

        <label>Date/Heure de r√©ception</label>
        <input type="text" id="datetime" readonly />

        <div class="half">
          <div>
            <label>Paiement</label>
            <select id="payment">
              <option value="Non">Non</option>
              <option value="Oui">Oui</option>
            </select>
          </div>
          <div>
            <label>R√©par√©</label>
            <select id="repaired">
              <option value="Non">Non</option>
              <option value="Oui">Oui</option>
            </select>
          </div>
        </div>

        <label>Type d'appareil *</label>
        <select id="deviceType" required>
          <option value="">S√©lectionner un type</option>
          <option value="desktop">Ordinateur de bureau</option>
          <option value="laptop">Ordinateur portable</option>
          <option value="server">Serveur</option>
          <option value="smartphone">Smartphone</option>
          <option value="tablet">Tablette</option>
          <option value="printer">Imprimante</option>
          <option value="console">Console</option>
          <option value="autre">Autre</option>
          <option value="manual">Ajouter manuellement</option>
        </select>

        <div id="dynamicFields"></div>

        <label>Description (optionnel)</label>
        <textarea id="description" placeholder="D√©tails suppl√©mentaires..."></textarea>

        <button type="submit" class="submit-btn">Soumettre l'appareil</button>
      </form>
    </div>
  </div>

  <!-- RECEIPT -->
  <div id="receiptPage" class="page" style="display:none;">
    <div class="glass-panel receipt-container">
      <h2>Re√ßu de d√©p√¥t</h2>
      <p><strong>ID:</strong> <span id="r-id"></span></p>
      <p><strong>Nom:</strong> <span id="r-name"></span></p>
      <p><strong>T√©l√©phone:</strong> <span id="r-phone"></span></p>
      <p><strong>Appareil:</strong> <span id="r-type"></span> - <span id="r-brand"></span> <span id="r-model"></span></p>
      <p><strong>Probl√®me:</strong> <span id="r-problem"></span></p>
      <p><strong>Date:</strong> <span id="r-date"></span></p>
      <p><strong>Paiement:</strong> <span id="r-payment"></span> | <strong>R√©par√©:</strong> <span id="r-repaired"></span></p>
      <p><strong>Description:</strong> <span id="r-desc"></span></p>
      <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimer le re√ßu</button>
      <button class="print-btn close-btn" onclick="showFormPage()">Fermer</button>
    </div>
  </div>

  <script>
    // ===== DATA ===== (same as before)
    const brandsByType = { /* ... your data ... */ };
    const modelsByBrand = { /* ... your data ... */ };
    const hardwareProblems = { /* ... your data ... */ };
    const softwareProblems = { /* ... your data ... */ };

    function showFormPage() {
      document.getElementById('formPage').classList.add('active');
      document.getElementById('receiptPage').style.display = 'none';
      document.getElementById('datetime').value = new Date().toLocaleString('fr-TN', { timeZone: 'Africa/Tunis' });
      document.getElementById('deviceType').value = '';
      document.getElementById('dynamicFields').innerHTML = '';
    }

    function createLabel(text) {
      const label = document.createElement('label');
      label.textContent = text;
      return label;
    }

    function updateModels(type, brand, modelSelect) {
      modelSelect.innerHTML = '<option value="">S√©lectionner un mod√®le</option>';
      if (modelsByBrand[brand] && modelsByBrand[brand][type]) {
        modelsByBrand[brand][type].forEach(model => {
          const opt = document.createElement('option');
          opt.value = model;
          opt.textContent = model;
          modelSelect.appendChild(opt);
        });
      }
    }

    function updateProblems(type, hwSelect, swSelect) {
      hwSelect.innerHTML = '<option value="">S√©lectionner un probl√®me mat√©riel</option>';
      swSelect.innerHTML = '<option value="">S√©lectionner un probl√®me logiciel</option>';
      if (hardwareProblems[type]) {
        hardwareProblems[type].forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = p;
          hwSelect.appendChild(opt);
        });
      }
      if (softwareProblems[type]) {
        softwareProblems[type].forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = p;
          swSelect.appendChild(opt);
        });
      }
    }

    function updateDynamicFields() {
      const type = document.getElementById('deviceType').value;
      const container = document.getElementById('dynamicFields');
      container.innerHTML = '';

      if (type === 'manual') {
        container.innerHTML = `
          <label>Type d'appareil (manuel)</label>
          <input type="text" id="manualType" placeholder="Ex: Drone, TV, etc." required />
          <label>Marque (manuel)</label>
          <input type="text" id="manualBrand" placeholder="Saisir la marque" required />
          <label>Mod√®le (manuel)</label>
          <input type="text" id="manualModel" placeholder="Saisir le mod√®le" required />
          <label>Probl√®me mat√©riel (manuel)</label>
          <input type="text" id="manualHardware" placeholder="Saisir le probl√®me mat√©riel" required />
          <label>Probl√®me logiciel (manuel)</label>
          <input type="text" id="manualSoftware" placeholder="Saisir le probl√®me logiciel" required />
        `;
      } else {
        const brandSelect = document.createElement('select');
        brandSelect.id = 'brand';
        brandSelect.required = true;
        brandSelect.innerHTML = '<option value="">S√©lectionner une marque</option>';
        if (brandsByType[type]) {
          brandsByType[type].forEach(brand => {
            const opt = document.createElement('option');
            opt.value = brand;
            opt.textContent = brand;
            brandSelect.appendChild(opt);
          });
        }

        const modelSelect = document.createElement('select');
        modelSelect.id = 'model';
        const hwSelect = document.createElement('select');
        hwSelect.id = 'problemHardware';
        const swSelect = document.createElement('select');
        swSelect.id = 'problemSoftware';

        modelSelect.innerHTML = '<option value="">S√©lectionner un mod√®le</option>';
        hwSelect.innerHTML = '<option value="">S√©lectionner un probl√®me mat√©riel</option>';
        swSelect.innerHTML = '<option value="">S√©lectionner un probl√®me logiciel</option>';

        container.appendChild(createLabel('Marque'));
        container.appendChild(brandSelect);
        container.appendChild(createLabel('Mod√®le'));
        container.appendChild(modelSelect);
        container.appendChild(createLabel('Probl√®me mat√©riel'));
        container.appendChild(hwSelect);
        container.appendChild(createLabel('Probl√®me logiciel'));
        container.appendChild(swSelect);

        brandSelect.addEventListener('change', () => {
          updateModels(type, brandSelect.value, modelSelect);
          updateProblems(type, hwSelect, swSelect);
        });

        updateModels(type, '', modelSelect);
        updateProblems(type, hwSelect, swSelect);
      }
    }

    document.getElementById('deviceType').addEventListener('change', updateDynamicFields);

    // ======================
    // SUBMIT FORM DIRECTLY TO GOOGLE SHEETS
    // ======================
    document.getElementById('deviceForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      let data;
      const type = document.getElementById('deviceType').value;

      if (type === 'manual') {
        data = {
          clientName: document.getElementById('clientName').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          datetime: document.getElementById('datetime').value,
          payment: document.getElementById('payment').value,
          repaired: document.getElementById('repaired').value,
          deviceType: document.getElementById('manualType').value,
          brand: document.getElementById('manualBrand').value,
          model: document.getElementById('manualModel').value,
          problemHardware: document.getElementById('manualHardware').value,
          problemSoftware: document.getElementById('manualSoftware').value,
          description: document.getElementById('description').value
        };
      } else {
        const brand = document.getElementById('brand').value || 'Non sp√©cifi√©';
        const model = document.getElementById('model').value || 'Non sp√©cifi√©';
        const problemHardware = document.getElementById('problemHardware').value || 'Aucun';
        const problemSoftware = document.getElementById('problemSoftware').value || 'Aucun';

        data = {
          clientName: document.getElementById('clientName').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          datetime: document.getElementById('datetime').value,
          payment: document.getElementById('payment').value,
          repaired: document.getElementById('repaired').value,
          deviceType: document.getElementById('deviceType').selectedOptions[0].text,
          brand: brand,
          model: model,
          problemHardware: problemHardware,
          problemSoftware: problemSoftware,
          description: document.getElementById('description').value
        };
      }

      try {
        const res = await fetch('/.netlify/functions/save-device', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.success) {
          document.getElementById('r-id').textContent = 'ID-' + result.id;
          document.getElementById('r-name').textContent = data.clientName;
          document.getElementById('r-phone').textContent = data.phone;
          document.getElementById('r-type').textContent = data.deviceType;
          document.getElementById('r-brand').textContent = data.brand;
          document.getElementById('r-model').textContent = data.model || 'N/A';
          document.getElementById('r-problem').textContent = (data.problemHardware || 'Aucun') + ' / ' + (data.problemSoftware || 'Aucun');
          document.getElementById('r-date').textContent = data.datetime;
          document.getElementById('r-payment').textContent = data.payment;
          document.getElementById('r-repaired').textContent = data.repaired;
          document.getElementById('r-desc').textContent = data.description || 'Aucune';

          document.getElementById('formPage').classList.remove('active');
          document.getElementById('receiptPage').style.display = 'block';
        } else {
          alert('‚ùå Erreur: ' + (result.error || '√âchec de la soumission'));
          console.error('Save error:', result.error);
        }
      } catch (err) {
        alert('‚ö†Ô∏è Erreur r√©seau. Veuillez v√©rifier votre connexion.');
        console.error('Network error:', err);
      }
    });

    // Initialize datetime
    document.getElementById('datetime').value = new Date().toLocaleString('fr-TN', { timeZone: 'Africa/Tunis' });

    // Initialize form
    document.getElementById('deviceType').value = '';
    document.getElementById('dynamicFields').innerHTML = '';
  </script>
</body>
</html>